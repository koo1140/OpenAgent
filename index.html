<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OpenAgent - Agentic Gateway</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Lexend:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg-primary: #0a0a0f;
  --bg-secondary: #13131c;
  --bg-tertiary: #1a1a28;
  --surface: rgba(30, 30, 45, 0.6);
  --surface-elevated: rgba(40, 40, 60, 0.8);
  --text-primary: #f5f5f7;
  --text-secondary: #a8a8b8;
  --text-muted: #6e6e80;
  --accent-gold: #f4d03f;
  --accent-amber: #ffa726;
  --accent-purple: #9c27b0;
  --accent-blue: #42a5f5;
  --danger: #ef5350;
  --success: #66bb6a;
  --glow: rgba(244, 208, 63, 0.15);
  --shadow: rgba(0, 0, 0, 0.3);
  --radius-sm: 12px;
  --radius-md: 18px;
  --radius-lg: 24px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

*{
  box-sizing:border-box;
  margin: 0;
  padding: 0;
}

body{
  margin:0;
  background: linear-gradient(135deg, #0a0a0f 0%, #13131c 50%, #1a1a28 100%);
  background-attachment: fixed;
  color: var(--text-primary);
  font-family: 'Lexend', -apple-system, system-ui, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.02);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(244, 208, 63, 0.3);
  border-radius: 4px;
  transition: var(--transition);
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(244, 208, 63, 0.5);
}

.page{
  flex: 1;
  display: none;
  flex-direction: column;
  max-width: 1600px;
  margin: 0 auto;
  width: 100%;
  overflow: hidden;
}

.page.active{
  display: flex;
  animation: pageEnter 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes pageEnter {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

header{
  padding: 24px 32px;
  background: linear-gradient(135deg, rgba(244, 208, 63, 0.1) 0%, rgba(156, 39, 176, 0.05) 100%);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(244, 208, 63, 0.1);
  position: relative;
  overflow: hidden;
}

header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
  opacity: 0.5;
}

header h1 {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 28px;
  background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-amber) 100%);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
  text-shadow: 0 0 30px var(--glow);
}

#mainLayout{
  flex: 1;
  display: flex;
  gap: 20px;
  padding: 20px 32px;
  overflow: hidden;
}

#sessionsPanel{
  width: 320px;
  background: var(--surface);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-lg);
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  border: 1px solid rgba(244, 208, 63, 0.1);
  box-shadow: 0 8px 32px var(--shadow);
  overflow: hidden;
}

.panel-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.panel-header h2 {
  font-family: 'Syne', sans-serif;
  font-weight: 700;
  font-size: 18px;
  color: var(--accent-gold);
  letter-spacing: -0.3px;
}

.session-create{
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(244, 208, 63, 0.1);
}

.sessions-list {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding-right: 4px;
}

.session-item{
  background: var(--bg-tertiary);
  padding: 14px;
  border-radius: var(--radius-md);
  display: flex;
  flex-direction: column;
  gap: 10px;
  cursor: pointer;
  transition: var(--transition);
  border: 1px solid transparent;
  position: relative;
  overflow: hidden;
}

.session-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(244, 208, 63, 0.05), rgba(156, 39, 176, 0.05));
  opacity: 0;
  transition: var(--transition);
}

.session-item:hover::before {
  opacity: 1;
}

.session-item:hover{
  transform: translateX(4px);
  border-color: rgba(244, 208, 63, 0.3);
}

.session-item.active{
  border-color: var(--accent-gold);
  background: linear-gradient(135deg, rgba(244, 208, 63, 0.1), rgba(156, 39, 176, 0.05));
  box-shadow: 0 4px 16px rgba(244, 208, 63, 0.2);
}

.session-item .session-title {
  font-weight: 600;
  font-size: 14px;
  color: var(--text-primary);
  position: relative;
  z-index: 1;
}

.session-item .session-info {
  font-size: 12px;
  color: var(--text-muted);
  position: relative;
  z-index: 1;
}

.session-actions{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  position: relative;
  z-index: 1;
}

.session-actions button{
  padding: 6px 12px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 600;
}

#chatArea{
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--surface);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-lg);
  border: 1px solid rgba(244, 208, 63, 0.1);
  box-shadow: 0 8px 32px var(--shadow);
  overflow: hidden;
}

.chat{
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.message{
  padding: 16px 20px;
  border-radius: var(--radius-md);
  max-width: 75%;
  font-size: 14.5px;
  line-height: 1.7;
  animation: messageEnter 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  box-shadow: 0 4px 12px var(--shadow);
}

@keyframes messageEnter {
  from {
    opacity: 0;
    transform: translateY(16px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.user{
  align-self: flex-end;
  background: linear-gradient(135deg, rgba(244, 208, 63, 0.15), rgba(255, 167, 38, 0.1));
  border: 1px solid rgba(244, 208, 63, 0.3);
  color: var(--text-primary);
}

.assistant{
  align-self: flex-start;
  background: var(--bg-tertiary);
  border: 1px solid rgba(156, 39, 176, 0.2);
}

.assistant::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(156, 39, 176, 0.05), rgba(66, 165, 245, 0.05));
  border-radius: var(--radius-md);
  pointer-events: none;
}

.message pre{
  background: rgba(0, 0, 0, 0.3);
  padding: 14px;
  border-radius: var(--radius-sm);
  overflow: auto;
  white-space: pre-wrap;
  word-break: break-word;
  font-size: 13px;
  border: 1px solid rgba(244, 208, 63, 0.1);
  margin: 8px 0;
}

.message code {
  background: rgba(244, 208, 63, 0.1);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 13px;
  color: var(--accent-gold);
}

.details{
  margin-top: 12px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: var(--radius-sm);
  padding: 12px;
  font-size: 12px;
  border: 1px solid rgba(244, 208, 63, 0.1);
}

.details summary{
  cursor: pointer;
  color: var(--accent-gold);
  font-weight: 600;
  user-select: none;
  display: flex;
  align-items: center;
  gap: 8px;
}

.details summary:hover {
  color: var(--accent-amber);
}

.details summary::marker {
  color: var(--accent-gold);
}

.details pre{
  background: rgba(0, 0, 0, 0.3);
  padding: 10px;
  border-radius: 8px;
  overflow: auto;
  margin-top: 10px;
  white-space: pre-wrap;
  word-break: break-word;
  font-size: 11px;
}

.tool-event{
  background: rgba(66, 165, 245, 0.1);
  border-radius: var(--radius-sm);
  padding: 10px;
  margin-top: 10px;
  border: 1px solid rgba(66, 165, 245, 0.2);
}

.tool-event .tool-title{
  font-weight: 600;
  color: var(--accent-blue);
  margin-bottom: 6px;
  font-size: 13px;
}

.input-area{
  padding: 20px;
  background: var(--bg-tertiary);
  display: flex;
  gap: 12px;
  border-top: 1px solid rgba(244, 208, 63, 0.1);
}

textarea{
  flex: 1;
  resize: none;
  min-height: 52px;
  max-height: 200px;
  border: none;
  outline: none;
  padding: 14px 16px;
  border-radius: var(--radius-md);
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-size: 14px;
  font-family: 'Lexend', sans-serif;
  border: 1px solid rgba(244, 208, 63, 0.2);
  transition: var(--transition);
}

textarea:focus {
  border-color: var(--accent-gold);
  box-shadow: 0 0 0 3px rgba(244, 208, 63, 0.1);
}

textarea::placeholder {
  color: var(--text-muted);
}

button{
  border: none;
  background: linear-gradient(135deg, var(--accent-gold), var(--accent-amber));
  color: var(--bg-primary);
  padding: 14px 24px;
  border-radius: var(--radius-md);
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  font-family: 'Lexend', sans-serif;
  font-size: 14px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(244, 208, 63, 0.3);
}

button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transition: left 0.5s;
}

button:hover::before {
  left: 100%;
}

button:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(244, 208, 63, 0.4);
}

button:active {
  transform: translateY(0);
}

button.small{
  padding: 8px 14px;
  border-radius: var(--radius-sm);
  font-size: 12px;
  box-shadow: 0 2px 8px rgba(244, 208, 63, 0.2);
}

button.secondary {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border: 1px solid rgba(244, 208, 63, 0.3);
  box-shadow: none;
}

button.secondary:hover {
  background: var(--bg-secondary);
  border-color: var(--accent-gold);
}

button.danger {
  background: linear-gradient(135deg, var(--danger), #c62828);
  color: white;
}

.nav{
  height: 70px;
  background: var(--surface);
  backdrop-filter: blur(20px);
  display: flex;
  border-top: 1px solid rgba(244, 208, 63, 0.1);
  box-shadow: 0 -4px 16px var(--shadow);
}

.nav button{
  flex: 1;
  background: none;
  color: var(--text-muted);
  border-radius: 0;
  box-shadow: none;
  font-size: 13px;
  font-weight: 500;
  position: relative;
  transition: var(--transition);
}

.nav button::before {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent-gold), var(--accent-amber));
  transform: translateX(-50%);
  transition: var(--transition);
  border-radius: 3px 3px 0 0;
}

.nav button.active{
  color: var(--accent-gold);
}

.nav button.active::before {
  width: 60%;
}

.nav button:hover {
  transform: none;
  color: var(--accent-amber);
  background: rgba(244, 208, 63, 0.05);
}

/* Thinking animation */
.thinking{
  display: flex;
  gap: 8px;
  padding: 16px 20px;
  background: var(--bg-tertiary);
  border-radius: var(--radius-md);
  width: fit-content;
  border: 1px solid rgba(156, 39, 176, 0.2);
  box-shadow: 0 4px 12px var(--shadow);
}

.dot{
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent-gold);
  animation: dotPulse 1.4s infinite both;
  box-shadow: 0 0 8px var(--glow);
}

.dot:nth-child(2){
  animation-delay: 0.2s;
}

.dot:nth-child(3){
  animation-delay: 0.4s;
}

@keyframes dotPulse {
  0%, 80%, 100% {
    opacity: 0.3;
    transform: scale(0.8);
  }
  40% {
    opacity: 1;
    transform: scale(1.2);
  }
}

.error{
  background: linear-gradient(135deg, var(--danger), #c62828);
  color: white;
  padding: 16px 20px;
  text-align: center;
  font-size: 14px;
  border-radius: var(--radius-md);
  margin: 0 32px 12px;
  box-shadow: 0 4px 16px rgba(239, 83, 80, 0.3);
  animation: errorShake 0.5s;
  font-weight: 500;
}

@keyframes errorShake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-8px); }
  75% { transform: translateX(8px); }
}

.progress{
  background: linear-gradient(135deg, rgba(156, 39, 176, 0.2), rgba(66, 165, 245, 0.2));
  color: var(--text-secondary);
  padding: 12px 20px;
  border-radius: var(--radius-md);
  margin: 0 32px 12px;
  font-size: 13px;
  font-weight: 500;
  border: 1px solid rgba(156, 39, 176, 0.3);
  box-shadow: 0 4px 12px var(--shadow);
  display: flex;
  align-items: center;
  gap: 12px;
}

.progress-container {
  margin: 0 32px 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.progress-bar-wrapper {
  width: 100%;
  height: 6px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 3px;
  overflow: hidden;
  border: 1px solid rgba(244, 208, 63, 0.1);
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-gold), var(--accent-amber));
  width: 0%;
  transition: width 0.12s linear;
  will-change: width;
  box-shadow: 0 0 10px var(--glow);
}

.progress-status {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 500;
}

.progress.hidden, .progress-container.hidden, .retry-container.hidden{
  display: none;
}

.retry-container {
    background: rgba(239, 83, 80, 0.1);
    border: 1px solid rgba(239, 83, 80, 0.3);
    border-radius: var(--radius-md);
    padding: 12px 16px;
    margin: 0 32px 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.retry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--danger);
    font-size: 13px;
    font-weight: 600;
}

.retry-bar-wrapper {
    width: 100%;
    height: 4px;
    background: rgba(239, 83, 80, 0.1);
    border-radius: 2px;
    overflow: hidden;
}

.retry-bar-fill {
    height: 100%;
    background: var(--danger);
    width: 100%;
}

.settings{
  padding: 32px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 28px;
}

.agent-card{
  background: var(--surface);
  backdrop-filter: blur(20px);
  padding: 24px;
  border-radius: var(--radius-lg);
  display: flex;
  flex-direction: column;
  gap: 16px;
  border: 1px solid rgba(244, 208, 63, 0.1);
  box-shadow: 0 8px 24px var(--shadow);
  transition: var(--transition);
}

.agent-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 32px var(--shadow);
  border-color: rgba(244, 208, 63, 0.2);
}

.agent-title{
  color: var(--accent-gold);
  font-weight: 700;
  font-size: 18px;
  font-family: 'Syne', sans-serif;
  letter-spacing: -0.3px;
  margin-bottom: 8px;
}

input, select, textarea.small{
  background: var(--bg-tertiary);
  border: 1px solid rgba(244, 208, 63, 0.2);
  padding: 12px 14px;
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  width: 100%;
  font-size: 14px;
  font-family: 'Lexend', sans-serif;
  transition: var(--transition);
}

input:focus, select:focus, textarea.small:focus {
  outline: none;
  border-color: var(--accent-gold);
  box-shadow: 0 0 0 3px rgba(244, 208, 63, 0.1);
}

select{
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23f4d03f' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

textarea.small{
  min-height: 80px;
  resize: vertical;
}

small{
  color: var(--text-muted);
  font-size: 12px;
}

label {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
  margin-bottom: 6px;
  display: block;
}

.row{
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.row label{
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text-muted);
  cursor: pointer;
}

input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--accent-gold);
}

/* Modal */
.modal{
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  animation: modalFade 0.3s ease;
}

@keyframes modalFade {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

.modal.hidden{
  display: none;
}

.modal-content{
  background: var(--bg-secondary);
  border-radius: var(--radius-lg);
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  padding: 32px;
  border: 1px solid rgba(244, 208, 63, 0.2);
  box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
  animation: modalSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalSlide {
  from {
    opacity: 0;
    transform: translateY(32px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header{
  font-family: 'Syne', sans-serif;
  font-size: 24px;
  font-weight: 700;
  color: var(--accent-gold);
  margin-bottom: 24px;
  letter-spacing: -0.5px;
}

.modal-actions{
  display: flex;
  gap: 12px;
  margin-top: 24px;
  flex-wrap: wrap;
}

/* Mobile Responsive */
@media (max-width: 968px) {
  #mainLayout {
    flex-direction: column;
    padding: 16px;
  }

  #sessionsPanel {
    width: 100%;
    max-height: 300px;
    order: 2;
  }

  #chatArea {
    order: 1;
    min-height: 400px;
  }

  .message {
    max-width: 90%;
  }

  header h1 {
    font-size: 24px;
  }

  .nav {
    height: 64px;
  }

  .settings {
    padding: 20px;
  }

  .modal-content {
    padding: 24px;
  }
}

@media (max-width: 640px) {
  header {
    padding: 20px;
  }

  #mainLayout {
    padding: 12px;
    gap: 12px;
  }

  .chat {
    padding: 16px;
  }

  .message {
    padding: 12px 16px;
    font-size: 14px;
  }

  .input-area {
    padding: 16px;
  }

  textarea {
    font-size: 14px;
  }

  button {
    padding: 12px 20px;
    font-size: 13px;
  }

  .nav {
    height: 60px;
  }

  .nav button {
    font-size: 12px;
  }

  .modal-content {
    padding: 20px;
  }

  .agent-card {
    padding: 20px;
  }
}

/* Empty state */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  text-align: center;
  color: var(--text-muted);
  gap: 16px;
}

.empty-state-icon {
  font-size: 48px;
  opacity: 0.5;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.empty-state-text {
  font-size: 16px;
  font-weight: 500;
  color: var(--text-secondary);
}
</style>
</head>
<body>

<div class="page active" id="chatPage">
  <header>
    <h1>OPENAGENT</h1>
  </header>

  <div class="error" id="errorBanner" style="display:none"></div>

  <div class="progress-container hidden" id="progressContainer">
    <div class="progress-status">
      <span id="progressText">Initializing...</span>
      <span id="progressPercent">0%</span>
    </div>
    <div class="progress-bar-wrapper">
      <div class="progress-bar-fill" id="progressBarFill"></div>
    </div>
  </div>

  <div class="retry-container hidden" id="retryContainer">
    <div class="retry-header">
      <span>Rate Limit hit. Retrying in <span id="retryTimer">30</span>s...</span>
    </div>
    <div class="retry-bar-wrapper">
      <div class="retry-bar-fill" id="retryBarFill"></div>
    </div>
  </div>

  <div id="mainLayout">
    <div id="sessionsPanel">
      <div class="panel-header">
        <h2>Sessions</h2>
      </div>
      <div class="session-create">
        <button onclick="createSession()">+ New Session</button>
      </div>
      <div class="sessions-list" id="sessionsList">
        <div class="empty-state">
          <div class="empty-state-icon">ðŸ’¬</div>
          <div class="empty-state-text">No sessions yet</div>
        </div>
      </div>
    </div>

    <div id="chatArea">
      <div class="chat" id="chat">
        <div class="empty-state">
          <div class="empty-state-icon">ðŸ¤–</div>
          <div class="empty-state-text">Start a conversation with your AI agent</div>
        </div>
      </div>
      <div class="input-area">
        <textarea id="input" placeholder="Type your message..." rows="1"></textarea>
        <button onclick="handleSend()">Send</button>
      </div>
    </div>
  </div>
</div>

<div class="modal hidden" id="decisionModal">
  <div class="modal-content">
    <div class="modal-header">Rate Limit Persistent</div>
    <p style="color: var(--text-secondary); margin-bottom: 20px;">The rate limit persists after retrying. Would you like to keep trying or stop?</p>
    <div class="modal-actions">
      <button onclick="handleDecision('continue')">Continue Trying</button>
      <button class="danger" onclick="handleDecision('stop')">Stop</button>
    </div>
  </div>
</div>

<div class="page" id="settingsPage">
  <header>
    <h1>SETTINGS</h1>
  </header>
  <div class="settings">
    <div class="agent-card">
      <div class="agent-title">Architecture Mode</div>
      <label>Mode</label>
      <select id="architecture_mode">
        <option value="legacy">legacy</option>
        <option value="hierarchical_v2">hierarchical_v2</option>
      </select>
    </div>

    <div class="agent-card">
      <div class="agent-title">Meta Agent</div>
      <label>Provider</label>
      <select id="meta_provider"></select>
      <label>Model</label>
      <input type="text" id="meta_model" placeholder="e.g. gpt-4">
      <label>API Key</label>
      <input type="password" id="meta_key" placeholder="sk-...">
      <label>Base URL (optional)</label>
      <input type="text" id="meta_base_url" placeholder="https://api.openai.com/v1/chat/completions">
      <label>Headers (JSON, optional)</label>
      <textarea class="small" id="meta_headers" placeholder='{"x-custom":"value"}'></textarea>
      <div class="row">
        <label><input type="checkbox" id="meta_supports_tools"> Supports Tools</label>
      </div>
    </div>

    <div class="agent-card">
      <div class="agent-title">Main Agent</div>
      <label>Provider</label>
      <select id="main_provider"></select>
      <label>Model</label>
      <input type="text" id="main_model" placeholder="e.g. gpt-4">
      <label>API Key</label>
      <input type="password" id="main_key" placeholder="sk-...">
      <label>Base URL (optional)</label>
      <input type="text" id="main_base_url" placeholder="https://api.openai.com/v1/chat/completions">
      <label>Headers (JSON, optional)</label>
      <textarea class="small" id="main_headers" placeholder='{"x-custom":"value"}'></textarea>
      <div class="row">
        <label><input type="checkbox" id="main_supports_tools"> Supports Tools</label>
      </div>
    </div>

    <div class="agent-card">
      <div class="agent-title">Sub Agent</div>
      <label>Provider</label>
      <select id="sub_provider"></select>
      <label>Model</label>
      <input type="text" id="sub_model" placeholder="e.g. gpt-4">
      <label>API Key</label>
      <input type="password" id="sub_key" placeholder="sk-...">
      <label>Base URL (optional)</label>
      <input type="text" id="sub_base_url" placeholder="https://api.openai.com/v1/chat/completions">
      <label>Headers (JSON, optional)</label>
      <textarea class="small" id="sub_headers" placeholder='{"x-custom":"value"}'></textarea>
      <div class="row">
        <label><input type="checkbox" id="sub_supports_tools"> Supports Tools</label>
      </div>
    </div>

    <div class="agent-card">
      <div class="agent-title">Orchestrator Agent</div>
      <label>Provider</label>
      <select id="orchestrator_provider"></select>
      <label>Model</label>
      <input type="text" id="orchestrator_model" placeholder="e.g. gpt-4">
      <label>API Key</label>
      <input type="password" id="orchestrator_key" placeholder="sk-...">
      <label>Base URL (optional)</label>
      <input type="text" id="orchestrator_base_url" placeholder="https://api.openai.com/v1/chat/completions">
      <label>Headers (JSON, optional)</label>
      <textarea class="small" id="orchestrator_headers" placeholder='{\"x-custom\":\"value\"}'></textarea>
      <div class="row">
        <label><input type="checkbox" id="orchestrator_supports_tools"> Supports Tools</label>
      </div>
    </div>

    <div class="agent-card">
      <div class="agent-title">Summarizer Agent</div>
      <label>Provider</label>
      <select id="summarizer_provider"></select>
      <label>Model</label>
      <input type="text" id="summarizer_model" placeholder="e.g. gpt-4">
      <label>API Key</label>
      <input type="password" id="summarizer_key" placeholder="sk-...">
      <label>Base URL (optional)</label>
      <input type="text" id="summarizer_base_url" placeholder="https://api.openai.com/v1/chat/completions">
      <label>Headers (JSON, optional)</label>
      <textarea class="small" id="summarizer_headers" placeholder='{\"x-custom\":\"value\"}'></textarea>
      <div class="row">
        <label><input type="checkbox" id="summarizer_supports_tools"> Supports Tools</label>
      </div>
    </div>

    <button onclick="saveConfig()">Save Configuration</button>
  </div>
</div>

<div class="nav">
  <button class="active" onclick="showPage('chat')">Chat</button>
  <button onclick="showPage('settings')">Settings</button>
</div>

<div class="modal hidden" id="toolModal">
  <div class="modal-content">
    <div class="modal-header">Tool Approval Required</div>
    <div id="pendingToolsList"></div>
    <div class="modal-actions">
      <button onclick="approveTools('run_once')">Run Once</button>
      <button class="secondary" onclick="approveTools('allow_session')">Allow for Session</button>
      <button class="danger" onclick="approveTools('deny')">Deny</button>
    </div>
  </div>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sessionsList = document.getElementById("sessionsList");
const errorBanner = document.getElementById("errorBanner");
const progressContainer = document.getElementById("progressContainer");
const progressText = document.getElementById("progressText");
const progressBarFill = document.getElementById("progressBarFill");
const progressPercent = document.getElementById("progressPercent");

const retryContainer = document.getElementById("retryContainer");
const retryTimer = document.getElementById("retryTimer");
const retryBarFill = document.getElementById("retryBarFill");

const toolModal = document.getElementById("toolModal");
const pendingToolsList = document.getElementById("pendingToolsList");
const decisionModal = document.getElementById("decisionModal");

let currentSessionId = null;
let sessionsCache = [];
let tempSessions = [];
let liveMessageDiv = null;
let liveToolEvents = [];
let liveSubagents = [];
let liveMeta = {};
let pendingMeta = null;
let pendingToolEvents = [];
let pendingSubagents = [];
let providers = {};
let progressCurrent = 0;
let progressTarget = 0;
let progressRaf = null;
let progressTicker = null;
let currentArchitectureMode = "legacy";

function renderProgress(){
  progressBarFill.style.width = progressCurrent.toFixed(1) + "%";
  progressPercent.textContent = Math.round(progressCurrent) + "%";
}

function animateProgress(){
  const diff = progressTarget - progressCurrent;
  if(Math.abs(diff) < 0.1){
    progressCurrent = progressTarget;
    renderProgress();
    progressRaf = null;
    return;
  }
  progressCurrent += diff * 0.2;
  renderProgress();
  progressRaf = requestAnimationFrame(animateProgress);
}

function ensureProgressAnimation(){
  if(progressRaf === null){
    progressRaf = requestAnimationFrame(animateProgress);
  }
}

function startProgressTicker(){
  if(progressTicker) return;
  progressTicker = setInterval(() => {
    if(progressContainer.classList.contains("hidden")) return;
    if(progressTarget < 95){
      progressTarget = Math.min(95, progressTarget + 0.6);
      ensureProgressAnimation();
    }
  }, 220);
}

function stopProgressTicker(){
  if(progressTicker){
    clearInterval(progressTicker);
    progressTicker = null;
  }
}

function showPage(page){
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
  if(page === "chat"){
    document.getElementById("chatPage").classList.add("active");
    document.querySelector(".nav button:nth-child(1)").classList.add("active");
  } else if(page === "settings"){
    document.getElementById("settingsPage").classList.add("active");
    document.querySelector(".nav button:nth-child(2)").classList.add("active");
  }
}

function showError(msg){
  errorBanner.textContent = msg;
  errorBanner.style.display = "block";
  setTimeout(() => {
    errorBanner.style.display = "none";
  }, 5000);
}

function showProgress(msg, percent){
  if(!msg){
    progressContainer.classList.add("hidden");
    stopProgressTicker();
    progressCurrent = 0;
    progressTarget = 0;
    renderProgress();
    return;
  }
  progressContainer.classList.remove("hidden");
  progressText.textContent = msg;
  if (percent !== undefined && percent !== null) {
    progressTarget = Math.max(progressTarget, Math.min(100, percent));
    ensureProgressAnimation();
  }
  startProgressTicker();
}

function completeProgress(){
  progressText.textContent = "Done";
  progressTarget = 100;
  ensureProgressAnimation();
  stopProgressTicker();
  setTimeout(() => showProgress(null), 280);
}

let retryInterval = null;
function startRateLimitCountdown(seconds){
    retryContainer.classList.remove("hidden");
    let remaining = seconds;
    retryTimer.textContent = remaining;
    retryBarFill.style.width = "100%";

    if(retryInterval) clearInterval(retryInterval);

    retryInterval = setInterval(() => {
        remaining--;
        retryTimer.textContent = remaining;
        retryBarFill.style.width = (remaining / seconds * 100) + "%";
        if(remaining <= 0){
            clearInterval(retryInterval);
            retryContainer.classList.add("hidden");
        }
    }, 1000);
}

function showRateLimitDecisionModal(){
    decisionModal.classList.remove("hidden");
}

async function handleDecision(decision){
    decisionModal.classList.add("hidden");
    try {
        await fetch("/api/chat/decision", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({session_id: currentSessionId, decision})
        });
    } catch(err) {
        showError("Failed to send decision: " + err.message);
    }
}

function addMessage(text, role){
  const isEmpty = chat.querySelector('.empty-state');
  if (isEmpty) {
    chat.innerHTML = '';
  }

  const div = document.createElement("div");
  div.className = `message ${role}`;
  if(role === "assistant"){
    div.innerHTML = marked.parse(text);
  } else {
    div.textContent = text;
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function startLiveMessage(){
  const isEmpty = chat.querySelector('.empty-state');
  if (isEmpty) {
    chat.innerHTML = '';
  }

  liveMessageDiv = document.createElement("div");
  liveMessageDiv.className = "message assistant";
  liveMessageDiv.innerHTML = "";
  chat.appendChild(liveMessageDiv);
  liveToolEvents = [];
  liveSubagents = [];
  // liveMeta is already being populated by meta_partial
  updateLiveDetails();
  chat.scrollTop = chat.scrollHeight;
}

function updateLiveMetaDetails() {
  if(!liveMessageDiv) {
    const keys = Object.keys(liveMeta).filter(k => k !== 'plan' && k !== 'gatekeeper');
    if(keys.length > 0) {
        showProgress("Meta Agents: " + keys.join(", ") + "...", 15);
    }
  } else {
    updateLiveDetails();
  }
}

function updateLiveMessage(content){
  if(!liveMessageDiv) return;
  liveMessageDiv.innerHTML = marked.parse(content || "");
  chat.scrollTop = chat.scrollHeight;
}

function updateLiveDetails(){
  if(!liveMessageDiv) return;
  const existingDetails = liveMessageDiv.querySelector(".details");
  if(existingDetails){
    existingDetails.remove();
  }
  if(Object.keys(liveMeta).length > 0 || liveToolEvents.length > 0 || liveSubagents.length > 0){
    const detailsHTML = buildDetailsHTML(liveMeta, liveToolEvents, liveSubagents);
    liveMessageDiv.insertAdjacentHTML("beforeend", detailsHTML);
  }
  chat.scrollTop = chat.scrollHeight;
}

function finalizeAssistantMessage(content, meta, toolEvents, subagentOutputs){
  if(liveMessageDiv){
    liveMessageDiv.remove();
    liveMessageDiv = null;
  }
  showProgress(null);
  addAssistantMessage(content, meta, toolEvents, subagentOutputs);
}

function addAssistantMessage(content, meta, toolEvents, subagentOutputs){
  const isEmpty = chat.querySelector('.empty-state');
  if (isEmpty) {
    chat.innerHTML = '';
  }

  const div = document.createElement("div");
  div.className = "message assistant";
  div.innerHTML = marked.parse(content || "");
  const detailsHTML = buildDetailsHTML(meta, toolEvents || [], subagentOutputs || []);
  if(detailsHTML){
    div.insertAdjacentHTML("beforeend", detailsHTML);
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function buildDetailsHTML(meta, toolEvents, subagentOutputs){
  if(!meta && (!toolEvents || toolEvents.length === 0) && (!subagentOutputs || subagentOutputs.length === 0)){
    return "";
  }
  let html = '<details class="details"><summary>Details</summary>';
  if(meta){
    if (typeof meta === 'string') {
      html += `<pre>${meta}</pre>`;
    } else if (meta.raw && Object.keys(meta).length === 1) {
      // If it only contains raw text from our new fallback
      html += `<pre>${meta.raw}</pre>`;
    } else {
      html += `<pre>${JSON.stringify(meta, null, 2)}</pre>`;
    }
  }
  if(toolEvents && toolEvents.length > 0){
    toolEvents.forEach(ev => {
      html += `<div class="tool-event">`;
      html += `<div class="tool-title">${ev.name} (${ev.status})</div>`;
      if(ev.args){
        html += `<pre>${JSON.stringify(ev.args, null, 2)}</pre>`;
      }
      if(ev.result){
        html += `<pre>${ev.result}</pre>`;
      }
      html += `</div>`;
    });
  }
  if(subagentOutputs && subagentOutputs.length > 0){
    subagentOutputs.forEach(sub => {
      html += `<div class="tool-event">`;
      html += `<div class="tool-title">Subagent: ${sub.task}</div>`;
      html += `<pre>${sub.result || sub.output || ""}</pre>`;
      html += `</div>`;
    });
  }
  html += '</details>';
  return html;
}

function showThinking(){
  const isEmpty = chat.querySelector('.empty-state');
  if (isEmpty) {
    chat.innerHTML = '';
  }

  const thinking = document.createElement("div");
  thinking.className = "thinking";
  thinking.id = "thinkingIndicator";
  thinking.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
  chat.appendChild(thinking);
  chat.scrollTop = chat.scrollHeight;
}

function removeThinking(){
  const thinking = document.getElementById("thinkingIndicator");
  if(thinking){
    thinking.remove();
  }
}

async function refreshSessions(){
  try{
    const res = await fetch("/api/sessions");
    if(!res.ok) throw new Error("Failed to load sessions");
    sessionsCache = await res.json();
    renderSessions();
  }catch(err){
    showError(err.message);
  }
}

function renderSessions(){
  const allSessions = [...sessionsCache, ...tempSessions];
  if(allSessions.length === 0){
    sessionsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ’¬</div><div class="empty-state-text">No sessions yet</div></div>';
    return;
  }
  sessionsList.innerHTML = "";
  allSessions.forEach(s => {
    const div = document.createElement("div");
    div.className = "session-item";
    if(s.id === currentSessionId){
      div.classList.add("active");
    }
    div.innerHTML = `
      <div class="session-title">${s.title || "Untitled"}</div>
      <div class="session-info">${s.persistent ? "Persistent" : "Temporary"} â€¢ ${s.turn_count || 0} turns</div>
      <div class="session-actions">
        <button class="small secondary" onclick="openSession('${s.id}')">Open</button>
        <button class="small secondary" onclick="renameSession('${s.id}')">Rename</button>
        <button class="small danger" onclick="deleteSession('${s.id}')">Delete</button>
      </div>
    `;
    sessionsList.appendChild(div);
  });
}

async function openSession(id){
  currentSessionId = id;
  renderSessions();
  try{
    const tempSession = tempSessions.find(s => s.id === id);
    if(tempSession){
      chat.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ¤–</div><div class="empty-state-text">Start a conversation</div></div>';
      return;
    }
    const res = await fetch(`/api/sessions/${id}`);
    if(!res.ok) throw new Error("Failed to load session");
    const data = await res.json();
    chat.innerHTML = "";
    data.turns.forEach(t => {
      addMessage(t.user_message, "user");
      addAssistantMessage(t.assistant_reply, t.meta_json || t.meta, t.tool_events, t.subagent_outputs);
    });
    if(data.turns.length === 0){
      chat.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ¤–</div><div class="empty-state-text">Start a conversation</div></div>';
    }
  }catch(err){
    showError(err.message);
  }
}

async function createSession(){
  try{
    const res = await fetch("/api/sessions", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({persistent: true})
    });
    if(!res.ok) throw new Error("Failed to create session");
    const session = await res.json();
    currentSessionId = session.id;
    sessionsCache.unshift(session);
    renderSessions();
    chat.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ¤–</div><div class="empty-state-text">Start a conversation</div></div>';
  }catch(err){
    showError(err.message);
  }
}

async function renameSession(id){
  const title = prompt("New session title?");
  if(!title) return;
  try{
    if(tempSessions.find(s => s.id === id)){
      tempSessions = tempSessions.map(s => s.id === id ? {...s, title} : s);
      renderSessions();
      return;
    }
    const res = await fetch(`/api/sessions/${id}`,{
      method:"PATCH",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({title})
    });
    if(!res.ok) throw new Error("Rename failed");
    sessionsCache = sessionsCache.map(s => s.id === id ? {...s, title} : s);
    renderSessions();
  }catch(err){
    showError(err.message);
  }
}

async function deleteSession(id){
  if(!confirm("Delete this session?")) return;
  try{
    if(tempSessions.find(s => s.id === id)){
      tempSessions = tempSessions.filter(s => s.id !== id);
      if(currentSessionId === id){
        currentSessionId = null;
        chat.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ¤–</div><div class="empty-state-text">Start a conversation</div></div>';
      }
      renderSessions();
      return;
    }
    const res = await fetch(`/api/sessions/${id}`,{method:"DELETE"});
    if(!res.ok) throw new Error("Delete failed");
    sessionsCache = sessionsCache.filter(s => s.id !== id);
    if(currentSessionId === id){
      currentSessionId = null;
      chat.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ¤–</div><div class="empty-state-text">Start a conversation</div></div>';
    }
    renderSessions();
  }catch(err){
    showError(err.message);
  }
}

async function ensureCurrentSession(){
  if(currentSessionId) return;
  if(sessionsCache.length){
    openSession(sessionsCache[0].id);
    return;
  }
  await createSession();
}

async function handleSend(){
  const text=input.value.trim();
  if(!text) return;
  input.value="";
  addMessage(text,"user");
  showThinking();
  pendingMeta = null;
  liveMeta = {};
  pendingToolEvents = [];
  pendingSubagents = [];
  try{
    if(!currentSessionId){
      await createSession();
    }
    const res=await fetch("/api/chat/stream",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({message:text, session_id: currentSessionId})
    });
    if(!res.ok) throw new Error("Backend error");
    removeThinking();
    startLiveMessage();
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = "";
    while(true){
      const {value, done} = await reader.read();
      if(done) break;
      buffer += decoder.decode(value, {stream:true});
      buffer = processSSEBuffer(buffer);
    }
  }catch(err){
    removeThinking();
    showProgress(null);
    if(liveMessageDiv){
      liveMessageDiv.remove();
      liveMessageDiv = null;
    }
    showError(err.message);
  }
}

function processSSEBuffer(buffer){
  const parts = buffer.split("\n\n");
  buffer = parts.pop();
  parts.forEach(chunk => handleSSEChunk(chunk));
  return buffer;
}

function handleSSEChunk(chunk){
  let eventType = "message";
  let dataStr = "";
  chunk.split("\n").forEach(line => {
    if(line.startsWith("event:")){
      eventType = line.slice(6).trim();
    }else if(line.startsWith("data:")){
      dataStr += line.slice(5).trim();
    }
  });
  if(!dataStr) return;
  let payload = null;
  try{
    payload = JSON.parse(dataStr);
  }catch(err){
    return;
  }
  handleSSEEvent(eventType, payload);
}

function handleSSEEvent(eventType, payload){
  if(payload && payload.architecture_mode){
    currentArchitectureMode = payload.architecture_mode;
  }
  if(eventType === "stage"){
    const name = payload.name || "";
    const map = currentArchitectureMode === "hierarchical_v2"
      ? {
          "main_thinking": ["Main Agent...", 12],
          "summarizer": ["Summarizer...", 30],
          "orchestrator": ["Orchestrator...", 45],
          "subagent": ["Sub-Agent...", 65],
          "finish": ["Finalizing...", 90]
        }
      : {
          "meta_start": ["Meta + Planner...", 8],
          "planning_start": ["System Planner...", 30],
          "gatekeeper_start": ["Gatekeeper...", 90],
          "subagents_start": ["Subagents...", 50],
          "tools_start": ["Tools...", 70]
        };
    const [msg, percent] = map[name] || [name, 0];
    showProgress(msg, percent);
    return;
  }
  if(eventType === "rate_limit_retry"){
    startRateLimitCountdown(payload.seconds || 30);
    return;
  }
  if(eventType === "rate_limit_error"){
    showRateLimitDecisionModal();
    return;
  }
  if(eventType === "meta_partial"){
    liveMeta = {...liveMeta, ...payload};
    updateLiveMetaDetails();
    showProgress("Meta ready...", 28);
    return;
  }
  if(eventType === "meta"){
    pendingMeta = payload;
    liveMeta = payload;
    updateLiveMetaDetails();
    showProgress("Generating response...", 45);
    return;
  }
  if(eventType === "token"){
    const currentContent = liveMessageDiv ? liveMessageDiv.textContent : "";
    updateLiveMessage(currentContent + payload.token);
    if(progressTarget < 85){
      showProgress(progressText.textContent || "Generating response...", 85);
    }
    return;
  }
  if(eventType === "tool_call"){
    liveToolEvents.push({name: payload.name, args: payload.args, status: "running"});
    updateLiveDetails();
    return;
  }
  if(eventType === "tool_result"){
    liveToolEvents.push({name: payload.name, status: payload.status, result: payload.result});
    updateLiveDetails();
    return;
  }
  if(eventType === "subagent"){
    liveSubagents.push(payload);
    updateLiveDetails();
    return;
  }
  if(eventType === "needs_approval"){
    pendingMeta = payload.meta || pendingMeta;
    pendingToolEvents = payload.tool_events || [];
    pendingSubagents = payload.subagent_outputs || [];
    if(payload.session_id){
      currentSessionId = payload.session_id;
    }
    if(liveMessageDiv){
      liveMessageDiv.remove();
      liveMessageDiv = null;
    }
    showToolApproval(payload.pending_tools || []);
    addAssistantMessage("Tool approval required.", null, payload.tool_events, payload.subagent_outputs);
    showProgress(null);
    return;
  }
  if(eventType === "assistant"){
    if(payload.session_id){
      currentSessionId = payload.session_id;
    }
    showProgress("Finalizing...", 98);
    finalizeAssistantMessage(payload.content, payload.meta, payload.tool_events, payload.subagent_outputs);
    return;
  }
  if(eventType === "done"){
    completeProgress();
  }
}

function showToolApproval(pendingTools){
  pendingToolsList.innerHTML = "";
  pendingTools.forEach(t => {
    const div = document.createElement("div");
    div.className = "tool-event";
    const title = document.createElement("div");
    title.className = "tool-title";
    title.textContent = `${t.name}`;
    const args = document.createElement("pre");
    args.textContent = typeof t.arguments === "string" ? t.arguments : JSON.stringify(t.arguments || {}, null, 2);
    div.appendChild(title);
    div.appendChild(args);
    pendingToolsList.appendChild(div);
  });
  toolModal.classList.remove("hidden");
}

function hideToolApproval(){
  toolModal.classList.add("hidden");
}

async function approveTools(decision){
  hideToolApproval();
  showThinking();
  try{
    const res = await fetch("/api/tools/approve",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({session_id: currentSessionId, decision})
    });
    if(!res.ok) throw new Error("Approval failed");
    const data = await res.json();
    removeThinking();
    if(data.status === "needs_approval"){
      pendingMeta = data.meta || pendingMeta;
      pendingToolEvents = data.tool_events || [];
      pendingSubagents = data.subagent_outputs || [];
      showToolApproval(data.pending_tools || []);
      addAssistantMessage("Tool approval required.", null, data.tool_events, data.subagent_outputs);
      return;
    }
    if(data.session_id){
      currentSessionId = data.session_id;
    }
    finalizeAssistantMessage(data.reply || "", data.meta, data.tool_events, data.subagent_outputs);
  }catch(err){
    removeThinking();
    showError(err.message);
  }
}

async function loadProviders(){
  try{
    const res = await fetch("/api/providers");
    if(!res.ok) throw new Error("Failed to load providers");
    providers = await res.json();
    const providerNames = Object.keys(providers);
    ["meta","main","sub","orchestrator","summarizer"].forEach(prefix => {
      const select = document.getElementById(`${prefix}_provider`);
      select.innerHTML = "";
      providerNames.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
      select.onchange = () => applyProviderDefaults(prefix, select.value);
      applyProviderDefaults(prefix, select.value);
    });
  }catch(err){
    showError(err.message);
  }
}

function applyProviderDefaults(prefix, providerName){
  const def = providers[providerName];
  if(!def) return;
  const baseUrlInput = document.getElementById(`${prefix}_base_url`);
  if(!baseUrlInput.value){
    baseUrlInput.value = def.base_url || "";
  }
  document.getElementById(`${prefix}_supports_tools`).checked = def.supports_tools !== false;
}

function fillProviderFields(prefix, cfg){
  const provider = cfg.provider || "OpenAI";
  document.getElementById(`${prefix}_provider`).value = provider;
  document.getElementById(`${prefix}_model`).value = cfg.model || "";
  document.getElementById(`${prefix}_key`).value = cfg.api_key || "";
  const def = providers[provider] || {};
  document.getElementById(`${prefix}_base_url`).value = cfg.base_url || def.base_url || "";
  document.getElementById(`${prefix}_headers`).value = cfg.headers ? JSON.stringify(cfg.headers, null, 2) : "";
  document.getElementById(`${prefix}_supports_tools`).checked =
    cfg.supports_tools !== undefined ? cfg.supports_tools : (def.supports_tools !== false);
}

async function loadConfig(){
  try{
    const res = await fetch("/api/config");
    if(!res.ok) return;
    const data = await res.json();
    currentArchitectureMode = data.architecture_mode || "legacy";
    document.getElementById("architecture_mode").value = currentArchitectureMode;
    fillProviderFields("meta", data.meta || {});
    fillProviderFields("main", data.main || {});
    fillProviderFields("sub", data.sub || {});
    fillProviderFields("orchestrator", data.orchestrator || data.meta || data.main || {});
    fillProviderFields("summarizer", data.summarizer || data.meta || data.main || {});
  }catch(err){
    showError(err.message);
  }
}

function buildProviderPayload(prefix){
  const provider = document.getElementById(`${prefix}_provider`).value;
  const model = document.getElementById(`${prefix}_model`).value;
  const api_key = document.getElementById(`${prefix}_key`).value;
  const base_url = document.getElementById(`${prefix}_base_url`).value || null;
  const headersText = document.getElementById(`${prefix}_headers`).value.trim();
  let headers = null;
  if(headersText){
    headers = JSON.parse(headersText);
  }
  const supports_tools = document.getElementById(`${prefix}_supports_tools`).checked;
  const provider_type = provider === "Anthropic" ? "anthropic" : "openai_compatible";
  // Defaulting supports_response_format to false as we removed it from UI
  return {provider, provider_type, model, api_key, base_url, headers, supports_tools, supports_response_format: false};
}

async function saveConfig(){
  try{
    currentArchitectureMode = document.getElementById("architecture_mode").value || "legacy";
    const payload = {
      architecture_mode: currentArchitectureMode,
      meta: buildProviderPayload("meta"),
      main: buildProviderPayload("main"),
      sub: buildProviderPayload("sub"),
      orchestrator: buildProviderPayload("orchestrator"),
      summarizer: buildProviderPayload("summarizer")
    };
    const res=await fetch("/api/config",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    if(!res.ok) throw new Error("Failed to save config");
    showPage("chat");
  }catch(err){
    showError(err.message);
  }
}

// Auto-resize textarea
input.addEventListener("input", () => {
  input.style.height = "auto";
  input.style.height = Math.min(input.scrollHeight, 200) + "px";
});

input.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){
    e.preventDefault();
    handleSend();
  }
});

window.addEventListener("load", async () => {
  await loadProviders();
  await loadConfig();
  await refreshSessions();
  await ensureCurrentSession();
});
</script>

</body>
</html>
